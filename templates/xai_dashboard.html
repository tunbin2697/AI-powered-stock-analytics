<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XAI Dashboard - TGNN++ Stock Prediction</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <style>
      .dashboard-container {
        margin: 20px;
      }

      .card {
        margin-bottom: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        background-color: #007bff;
        color: white;
        font-weight: bold;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-ready {
        background-color: #28a745;
      }
      .status-training {
        background-color: #ffc107;
      }
      .status-error {
        background-color: #dc3545;
      }

      .metric-card {
        text-align: center;
        padding: 20px;
      }

      .metric-value {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
      }

      .metric-label {
        color: #6c757d;
        margin-top: 5px;
      }

      .loading {
        text-align: center;
        padding: 40px;
      }

      .error-message {
        color: #dc3545;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }

      .success-message {
        color: #155724;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      #davots-plot,
      #icfts-plot,
      #prediction-plot,
      #feature-importance-plot {
        height: 600px;
        min-height: 500px;
        width: 100%;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background-color: #fafafa;
      }

      #davots-plot {
        height: 700px; /* Extra height for DAVOTS heatmap */
      }

      .plot-container {
        position: relative;
        overflow: hidden;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 15px;
      }

      @media (max-width: 768px) {
        .summary-grid {
          grid-template-columns: 1fr;
        }

        #davots-plot,
        #icfts-plot,
        #prediction-plot,
        #feature-importance-plot {
          height: 400px;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <div class="row">
        <div class="col-12">
          <h1 class="mb-4">üß† XAI Dashboard - TGNN++ Stock Prediction</h1>
          <p class="lead">
            Explainable AI for Multi-Modal Stock Price Prediction using DAVOTS,
            ICFTS, and TGNN++
          </p>
        </div>
      </div>

      <!-- Control Panel -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">üéõÔ∏è Control Panel</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-3">
                  <label for="ticker" class="form-label">Stock Ticker</label>
                  <input
                    type="text"
                    class="form-control"
                    id="ticker"
                    value="AAPL"
                    placeholder="e.g., AAPL"
                  />
                </div>
                <div class="col-md-3">
                  <label for="start-date" class="form-label">Start Date</label>
                  <input type="date" class="form-control" id="start-date" />
                </div>
                <div class="col-md-3">
                  <label for="end-date" class="form-label">End Date</label>
                  <input type="date" class="form-control" id="end-date" />
                </div>
                <div class="col-md-3">
                  <label for="epochs" class="form-label">Training Epochs</label>
                  <input
                    type="number"
                    class="form-control"
                    id="epochs"
                    value="50"
                    min="10"
                    max="200"
                  />
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-12">
                  <button
                    class="btn btn-primary me-2"
                    onclick="integrateData()"
                  >
                    üìä Integrate Data
                  </button>
                  <button class="btn btn-success me-2" onclick="trainModel()">
                    üöÄ Train Model
                  </button>
                  <button class="btn btn-warning me-2" onclick="runDAVOTS()">
                    üîç DAVOTS Analysis
                  </button>
                  <button class="btn btn-info me-2" onclick="runICFTS()">
                    ‚ö° ICFTS Analysis
                  </button>
                  <button
                    class="btn btn-secondary me-2"
                    onclick="predictPrice()"
                  >
                    üí∞ Predict Price
                  </button>
                  <button
                    class="btn btn-outline-primary"
                    onclick="getModelStatus()"
                  >
                    üìà Model Status
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Status Panel -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">üìä System Status</h5>
            </div>
            <div class="card-body">
              <div id="status-messages"></div>
              <div class="row" id="status-indicators">
                <div class="col-md-3">
                  <div class="metric-card">
                    <div>
                      <span
                        class="status-indicator status-ready"
                        id="data-status"
                      ></span>
                      Data Integration
                    </div>
                    <div class="small text-muted" id="data-info">
                      Not started
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="metric-card">
                    <div>
                      <span
                        class="status-indicator status-ready"
                        id="model-status"
                      ></span>
                      Model Training
                    </div>
                    <div class="small text-muted" id="model-info">
                      Not started
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="metric-card">
                    <div>
                      <span
                        class="status-indicator status-ready"
                        id="xai-status"
                      ></span>
                      XAI Analysis
                    </div>
                    <div class="small text-muted" id="xai-info">
                      Not started
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="metric-card">
                    <div>
                      <span
                        class="status-indicator status-ready"
                        id="prediction-status"
                      ></span>
                      Prediction
                    </div>
                    <div class="small text-muted" id="prediction-info">
                      Not started
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- XAI Analysis Results -->
      <div class="row">
        <!-- DAVOTS Analysis (Full Width) -->
        <div class="col-12 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                üîç DAVOTS - Deep Attribution Visualization Over Time Series
              </h5>
              <small class="text-light">
                Explainable AI analysis showing feature importance across time
                steps
              </small>
            </div>
            <div class="card-body">
              <div id="davots-loading" class="loading" style="display: none">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">
                  Running DAVOTS analysis... This may take a moment.
                </p>
              </div>
              <div class="plot-container">
                <div id="davots-plot"></div>
              </div>
              <div id="davots-summary" class="mt-4"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- ICFTS Analysis -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">‚ö° ICFTS - Integrated Causal Feature</h5>
            </div>
            <div class="card-body">
              <div id="icfts-loading" class="loading" style="display: none">
                <div class="spinner-border" role="status"></div>
                <p>Running ICFTS analysis...</p>
              </div>
              <div id="icfts-plot"></div>
              <div id="icfts-summary" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Prediction Results -->
      <div class="row">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">üí∞ Price Prediction & Feature Importance</h5>
            </div>
            <div class="card-body">
              <div
                id="prediction-loading"
                class="loading"
                style="display: none"
              >
                <div class="spinner-border" role="status"></div>
                <p>Generating predictions...</p>
              </div>
              <div id="prediction-plot"></div>
              <div id="feature-importance-plot" class="mt-3"></div>
            </div>
          </div>
        </div>

        <!-- Model Metrics -->
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">üìà Model Performance</h5>
            </div>
            <div class="card-body">
              <div id="model-metrics">
                <div class="metric-card">
                  <div class="metric-value" id="mse-value">--</div>
                  <div class="metric-label">Avg Feature Importance</div>
                </div>
                <div class="metric-card">
                  <div class="metric-value" id="mae-value">--</div>
                  <div class="metric-label">Positive Features</div>
                </div>
                <div class="metric-card">
                  <div class="metric-value" id="r2-value">--</div>
                  <div class="metric-label">Negative Features</div>
                </div>
                <div class="metric-card">
                  <div class="metric-value" id="accuracy-value">--</div>
                  <div class="metric-label">Total Features</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Initialize dates
      const today = new Date();
      const thirtyDaysAgo = new Date(
        today.getTime() - 30 * 24 * 60 * 60 * 1000
      );
      document.getElementById("start-date").value = thirtyDaysAgo
        .toISOString()
        .split("T")[0];
      document.getElementById("end-date").value = today
        .toISOString()
        .split("T")[0];

      // Utility functions
      function showMessage(message, type = "info") {
        const messagesDiv = document.getElementById("status-messages");
        const alertClass =
          type === "error" ? "error-message" : "success-message";
        messagesDiv.innerHTML = `<div class="${alertClass}">${message}</div>`;
        setTimeout(() => (messagesDiv.innerHTML = ""), 5000);
      }

      function updateStatus(component, status, info) {
        const statusElement = document.getElementById(`${component}-status`);
        const infoElement = document.getElementById(`${component}-info`);

        statusElement.className = `status-indicator status-${status}`;
        if (infoElement) infoElement.textContent = info;
      }

      function showLoading(component, show = true) {
        const loadingElement = document.getElementById(`${component}-loading`);
        if (loadingElement) {
          loadingElement.style.display = show ? "block" : "none";
        }
      }

      function formatFeatureName(name) {
        // Format feature names for better display
        if (name.startsWith("macro_")) {
          return name.replace("macro_", "").replace(/_/g, " ");
        }
        if (name.startsWith("news_emb_")) {
          const embNum = name.replace("news_emb_", "");
          return `News Emb ${embNum}`;
        }
        return name.replace(/_/g, " ");
      }

      function getCategoryIcon(featureName) {
        if (featureName.startsWith("macro_")) return "üìä";
        if (featureName.startsWith("news_emb_")) return "üì∞";
        if (["Volume", "Volume_SMA", "Volume_Ratio"].includes(featureName))
          return "üìà";
        if (["SMA_20", "EMA_12", "EMA_26", "MACD"].includes(featureName))
          return "üìâ";
        if (featureName.includes("BB_")) return "üéØ";
        return "üí≤";
      }

      // API functions
      async function integrateData() {
        const ticker = document.getElementById("ticker").value;
        const startDate = document.getElementById("start-date").value;
        const endDate = document.getElementById("end-date").value;

        updateStatus("data", "training", "Integrating data...");
        showMessage("Integrating multi-modal data...", "info");

        try {
          const response = await fetch(
            `/lab2/xai/integrate_data?ticker=${ticker}&start=${startDate}&end=${endDate}`
          );
          const data = await response.json();

          if (response.ok) {
            updateStatus(
              "data",
              "ready",
              `${data.data_shape[0]} samples, ${data.data_shape[1]} features`
            );
            showMessage(
              `Data integration successful! Shape: ${data.data_shape[0]}x${data.data_shape[1]}`,
              "success"
            );

            // Store data info for other functions
            window.lastIntegratedData = {
              ticker: ticker,
              start: startDate,
              end: endDate,
              shape: data.data_shape,
              features: data.feature_summary,
            };
          } else {
            updateStatus("data", "error", "Integration failed");
            showMessage(`Data integration failed: ${data.error}`, "error");
          }
        } catch (error) {
          updateStatus("data", "error", "Network error");
          showMessage(
            `Network error during data integration: ${error.message}`,
            "error"
          );
        }
      }
      async function trainModel() {
        const ticker = document.getElementById("ticker").value;
        const startDate = document.getElementById("start-date").value;
        const endDate = document.getElementById("end-date").value;
        const epochs = parseInt(document.getElementById("epochs").value);

        updateStatus("model", "training", "Training in progress...");
        showMessage("Training TGNN++ model...", "info");

        try {
          const response = await fetch("/lab2/xai/train_model", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              ticker,
              start: startDate,
              end: endDate,
              epochs,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            updateStatus("model", "ready", `Trained for ${epochs} epochs`);
            showMessage(
              `Model training completed! Model saved to: ${data.model_path}`,
              "success"
            );

            // Store model info for other functions
            window.lastTrainedModel = {
              path: data.model_path,
              ticker: ticker,
              epochs: epochs,
              features: data.feature_names,
            };

            // Update metrics if available
            if (data.training_stats) {
              const stats = data.training_stats;
              document.getElementById("mse-value").textContent =
                stats.final_train_loss?.toFixed(4) || "--";
              document.getElementById("mae-value").textContent =
                stats.final_val_loss?.toFixed(4) || "--";
              document.getElementById("r2-value").textContent = "--"; // Not provided in training stats
              document.getElementById(
                "accuracy-value"
              ).textContent = `${stats.feature_count} features`;
            }
          } else {
            updateStatus("model", "error", "Training failed");
            showMessage(`Model training failed: ${data.error}`, "error");
          }
        } catch (error) {
          updateStatus("model", "error", "Network error");
          showMessage(
            `Network error during model training: ${error.message}`,
            "error"
          );
        }
      }
      async function runDAVOTS() {
        const ticker = document.getElementById("ticker").value;

        if (!window.lastTrainedModel) {
          showMessage(
            "Please train a model first before running DAVOTS analysis.",
            "error"
          );
          return;
        }

        updateStatus("xai", "training", "Running DAVOTS...");
        showLoading("davots", true);
        showMessage("Running DAVOTS attribution analysis...", "info");

        try {
          const modelPath = window.lastTrainedModel.path;
          const response = await fetch(
            `/lab2/xai/davots?ticker=${ticker}&model_path=${encodeURIComponent(
              modelPath
            )}`
          );

          const data = await response.json();
          showLoading("davots", false);

          if (response.ok) {
            updateStatus("xai", "ready", "DAVOTS completed");
            showMessage("DAVOTS analysis completed successfully!", "success"); // Plot DAVOTS results
            if (data.attribution_plot) {
              const plotData = JSON.parse(data.attribution_plot);

              // Configure plot for better display
              const config = {
                displayModeBar: true,
                modeBarButtonsToRemove: ["pan2d", "lasso2d", "select2d"],
                displaylogo: false,
                responsive: true,
              };

              // Update layout for better visualization
              if (plotData.layout) {
                plotData.layout.autosize = true;
                plotData.layout.height = 600;
                plotData.layout.margin = { l: 250, r: 50, t: 80, b: 100 };
                plotData.layout.font = { size: 12 };
                plotData.layout.xaxis.title = "Time Steps";
                plotData.layout.yaxis.title = "Features";
                plotData.layout.title = {
                  text: `DAVOTS - Feature Attribution Over Time (${data.ticker})`,
                  font: { size: 16 },
                  x: 0.5,
                };
              }

              Plotly.newPlot(
                "davots-plot",
                plotData.data,
                plotData.layout,
                config
              );

              // Add resize event listener
              window.addEventListener("resize", function () {
                Plotly.Plots.resize("davots-plot");
              });
            }

            // Show detailed summary
            if (data.feature_importance_summary && data.top_features) {
              const summary = data.feature_importance_summary;
              // Format top features properly
              let topFeaturesHtml = "";
              if (Array.isArray(data.top_features)) {
                topFeaturesHtml = '<div class="list-group list-group-flush">';
                data.top_features.slice(0, 5).forEach((feature, index) => {
                  if (Array.isArray(feature) && feature.length >= 2) {
                    const [name, score] = feature;
                    const formattedName = formatFeatureName(name);
                    const icon = getCategoryIcon(name);
                    const percentage = (score * 100).toFixed(4);
                    const badgeColor =
                      index === 0
                        ? "bg-primary"
                        : index === 1
                        ? "bg-success"
                        : "bg-secondary";

                    topFeaturesHtml += `
                      <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                          ${icon} <strong>${formattedName}</strong>
                          <br><small class="text-muted">${name}</small>
                        </span>
                        <span class="badge ${badgeColor} rounded-pill">${percentage}%</span>
                      </div>
                    `;
                  } else if (typeof feature === "string") {
                    const icon = getCategoryIcon(feature);
                    topFeaturesHtml += `
                      <div class="list-group-item">
                        ${icon} ${formatFeatureName(feature)}
                      </div>
                    `;
                  }
                });
                topFeaturesHtml += "</div>";
              }

              document.getElementById("davots-summary").innerHTML = `
                <div class="row">
                  <div class="col-md-6">
                    <h6>üìä Attribution Summary:</h6>
                    <ul class="list-unstyled">
                      <li><strong>üî∫ Most Influential:</strong> <code>${
                        summary.most_positive
                      }</code></li>
                      <li><strong>üîª Least Influential:</strong> <code>${
                        summary.most_negative
                      }</code></li>
                      <li><strong>üìà Average Attribution:</strong> ${(
                        summary.avg_attribution * 100
                      ).toFixed(6)}%</li>
                      <li><strong>üéØ Analysis Method:</strong> ${
                        data.method || "Integrated Gradients"
                      }</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6>üèÜ Top Contributing Features:</h6>
                    ${topFeaturesHtml}
                  </div>
                </div>
                <div class="mt-3">
                  <small class="text-muted">
                    <i>‚ÑπÔ∏è The heatmap shows feature attribution over the last 30 time steps. 
                    Darker colors indicate higher influence on the model's prediction.</i>
                  </small>
                </div>
              `;
            }
          } else {
            updateStatus("xai", "error", "DAVOTS failed");
            showMessage(`DAVOTS analysis failed: ${data.error}`, "error");
          }
        } catch (error) {
          showLoading("davots", false);
          updateStatus("xai", "error", "Network error");
          showMessage(
            `Network error during DAVOTS analysis: ${error.message}`,
            "error"
          );
        }
      }
      async function runICFTS() {
        const ticker = document.getElementById("ticker").value;

        updateStatus("xai", "training", "Running ICFTS...");
        showLoading("icfts", true);
        showMessage("Running ICFTS causal analysis...", "info");

        try {
          const response = await fetch(
            `/lab2/xai/icfts?ticker=${ticker}&sentiment_var=avg_sentiment&target_var=close_price`
          );

          const data = await response.json();
          showLoading("icfts", false);

          if (response.ok) {
            updateStatus("xai", "ready", "ICFTS completed");
            showMessage("ICFTS analysis completed successfully!", "success");

            // Plot ICFTS results
            if (data.causal_graph_plot) {
              const plotData = JSON.parse(data.causal_graph_plot);
              Plotly.newPlot("icfts-plot", plotData.data, plotData.layout);
            }

            // Show summary
            if (data.interpretation) {
              const interp = data.interpretation;
              document.getElementById("icfts-summary").innerHTML = `
                            <h6>Causal Analysis Summary:</h6>
                            <p><strong>Causal relationship:</strong> ${
                              interp.causal_relationship ? "Yes" : "No"
                            }</p>
                            <p><strong>Strength level:</strong> ${
                              interp.strength_level
                            }</p>
                            <p><strong>Causal strength:</strong> ${data.causal_strength.toFixed(
                              4
                            )}</p>
                            <p><strong>Statistical significance:</strong> ${
                              interp.statistical_significance ? "Yes" : "No"
                            } (p=${data.p_value.toFixed(4)})</p>
                        `;
            }
          } else {
            updateStatus("xai", "error", "ICFTS failed");
            showMessage(`ICFTS analysis failed: ${data.error}`, "error");
          }
        } catch (error) {
          showLoading("icfts", false);
          updateStatus("xai", "error", "Network error");
          showMessage(
            `Network error during ICFTS analysis: ${error.message}`,
            "error"
          );
        }
      }
      async function predictPrice() {
        const ticker = document.getElementById("ticker").value;
        const predictionDays = 5; // Default prediction days

        if (!window.lastTrainedModel) {
          showMessage(
            "Please train a model first before making predictions.",
            "error"
          );
          return;
        }

        updateStatus("prediction", "training", "Generating predictions...");
        showLoading("prediction", true);
        showMessage("Generating price predictions...", "info");

        try {
          const response = await fetch("/lab2/xai/predict", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              ticker: ticker,
              model_path: window.lastTrainedModel.path,
              prediction_days: predictionDays,
            }),
          });

          const data = await response.json();
          showLoading("prediction", false);

          if (response.ok) {
            updateStatus("prediction", "ready", "Predictions generated");
            showMessage("Price predictions generated successfully!", "success");

            // Plot predictions
            if (data.prediction_plot) {
              const plotData = JSON.parse(data.prediction_plot);
              Plotly.newPlot("prediction-plot", plotData.data, plotData.layout);
            }

            // Update prediction summary
            if (data.prediction_summary) {
              const summary = data.prediction_summary;
              const summaryHtml = `
                            <div class="mt-3">
                                <h6>Prediction Summary:</h6>
                                <p><strong>Current Price:</strong> $${data.current_price.toFixed(
                                  2
                                )}</p>
                                <p><strong>Average Predicted:</strong> $${summary.avg_predicted_price.toFixed(
                                  2
                                )}</p>
                                <p><strong>Price Trend:</strong> ${
                                  summary.price_trend
                                }</p>
                                <p><strong>Expected Change:</strong> ${
                                  summary.expected_change >= 0 ? "+" : ""
                                }$${summary.expected_change.toFixed(
                2
              )} (${summary.expected_change_pct.toFixed(1)}%)</p>
                                <p><strong>Prediction Dates:</strong> ${data.prediction_dates.join(
                                  ", "
                                )}</p>
                            </div>
                        `;
              document
                .getElementById("prediction-plot")
                .insertAdjacentHTML("afterend", summaryHtml);
            }

            // Get and display feature importance
            getFeatureImportance();
          } else {
            updateStatus("prediction", "error", "Prediction failed");
            showMessage(`Price prediction failed: ${data.error}`, "error");
          }
        } catch (error) {
          showLoading("prediction", false);
          updateStatus("prediction", "error", "Network error");
          showMessage(
            `Network error during prediction: ${error.message}`,
            "error"
          );
        }
      }
      async function getModelStatus() {
        showMessage("Checking model status...", "info");

        try {
          const response = await fetch("/lab2/xai/model_status");
          const data = await response.json();

          if (response.ok) {
            showMessage("Model status retrieved successfully!", "success");

            // Display available models info
            const modelInfo = `
                        <div class="mt-2">
                            <strong>Available Models:</strong> ${
                              data.model_count
                            }<br>
                            ${
                              data.latest_model
                                ? `<strong>Latest:</strong> ${data.latest_model.name} (${data.latest_model.size_mb}MB, ${data.latest_model.created_date})`
                                : "No models found"
                            }
                        </div>
                    `;
            document.getElementById("model-info").innerHTML = modelInfo;

            // Update status indicators based on available models
            if (data.model_count > 0) {
              updateStatus(
                "model",
                "ready",
                `${data.model_count} models available`
              );
              // Store latest model info if available
              if (data.latest_model && !window.lastTrainedModel) {
                window.lastTrainedModel = {
                  path: data.latest_model.path,
                  name: data.latest_model.name,
                };
              }
            } else {
              updateStatus("model", "ready", "No trained models");
            }
          } else {
            showMessage(`Failed to get model status: ${data.error}`, "error");
          }
        } catch (error) {
          showMessage(
            `Network error getting model status: ${error.message}`,
            "error"
          );
        }
      }

      // New function to get feature importance
      async function getFeatureImportance() {
        const ticker = document.getElementById("ticker").value;

        if (!window.lastTrainedModel) {
          return; // Skip if no model available
        }

        try {
          const response = await fetch(
            `/lab2/xai/feature_importance?ticker=${ticker}&model_path=${encodeURIComponent(
              window.lastTrainedModel.path
            )}`
          );
          const data = await response.json();

          if (response.ok) {
            // Plot feature importance
            if (data.feature_importance_plot) {
              const plotData = JSON.parse(data.feature_importance_plot);
              Plotly.newPlot(
                "feature-importance-plot",
                plotData.data,
                plotData.layout
              );
            }

            // Update metrics with feature importance stats
            if (data.overall_stats) {
              document.getElementById("mse-value").textContent =
                data.overall_stats.avg_importance.toFixed(4);
              document.getElementById("mae-value").textContent =
                data.overall_stats.positive_features.toString();
              document.getElementById("r2-value").textContent =
                data.overall_stats.negative_features.toString();
              document.getElementById("accuracy-value").textContent =
                data.overall_stats.total_features.toString();
            }
          } else {
            console.warn("Feature importance analysis failed:", data.error);
          }
        } catch (error) {
          console.warn(
            "Network error during feature importance analysis:",
            error.message
          );
        }
      } // Auto-refresh model status every 30 seconds
      setInterval(getModelStatus, 30000);

      // Initial status check
      getModelStatus(); // Fake Chatbot Functions
      const geminiResponses = [
        "DAVOTS (Deep Attribution Visualization Over Time Series) is a sophisticated explainable AI technique that provides temporal feature attribution for time series models. It helps understand which features contribute most to predictions at different time points.",
        "TGNN++ (Temporal Graph Neural Network Plus Plus) is an advanced architecture that combines graph neural networks with temporal modeling. It's designed to capture both spatial relationships between features and temporal dependencies in time series data.",
        "ICFTS (Interventional Causal Framework for Time Series) is a causal inference method that uses interventional analysis to understand cause-and-effect relationships in temporal data. It helps identify which variables actually drive changes in predictions.",
        "Yahoo Finance API provides real-time and historical stock market data including prices, volumes, dividends, and stock splits. It's a popular data source for financial analysis and algorithmic trading systems.",
        "Macro indicators like Federal Funds Rate, GDP, unemployment rate, and CPI are crucial economic metrics that influence stock market movements. They represent the broader economic environment affecting individual securities.",
        "News embeddings are vector representations of financial news articles created using natural language processing. They capture semantic meaning and sentiment, allowing models to incorporate news sentiment into stock predictions.",
        "Technical indicators like RSI, MACD, Bollinger Bands, and moving averages are mathematical calculations based on price and volume data. They help identify trends, momentum, and potential reversal points in stock prices.",
        "The integrated gradients method computes feature attributions by integrating gradients along a path from a baseline to the actual input. This provides more stable and meaningful feature importance scores than simple gradients.",
        "Multi-modal data integration combines different types of information (price data, news, macroeconomic indicators) into a unified dataset. This provides a more comprehensive view for financial prediction models.",
        "Temporal Graph Neural Networks excel at modeling complex relationships between features that change over time. They can capture how the importance of different economic indicators varies during different market conditions.",
        "Feature attribution helps explain why a model made a specific prediction by showing which input features contributed most to that decision. This is crucial for building trust in AI-driven financial decisions.",
        "The FRED (Federal Reserve Economic Data) API provides access to thousands of economic time series data from various government agencies. It's essential for incorporating macroeconomic context into financial models.",
        "Volatility clustering in financial markets means that periods of high volatility tend to be followed by periods of high volatility. TGNN++ can capture these temporal patterns through its attention mechanisms.",
        "Concept drift occurs when the statistical properties of the data change over time, causing model performance to degrade. DAVOTS can help detect when models are relying on outdated patterns.",
        "Sentiment analysis of financial news uses NLP techniques to extract emotional tone and market sentiment from text. This sentiment can be a powerful predictor of short-term stock movements.",
      ];
      const watsonResponses = [
        "DAVOTS represents a breakthrough in explainable artificial intelligence for temporal data analysis. It provides granular insights into how deep learning models make predictions by attributing importance to features across time dimensions.",
        "TGNN++ architecture represents a significant advancement in temporal modeling for financial applications. It combines the spatial reasoning capabilities of graph neural networks with sophisticated temporal attention mechanisms.",
        "ICFTS methodology enables robust causal inference in financial time series by using interventional techniques. This approach helps distinguish between correlation and causation in complex market dynamics.",
        "Yahoo Finance integration provides enterprise-grade market data access with comprehensive coverage of global equities, indices, and derivatives. Its API supports real-time and historical data retrieval for systematic trading strategies.",
        "Macroeconomic indicators serve as leading, lagging, and coincident signals for market movements. Watson's analysis shows that incorporating FRED data significantly improves prediction accuracy in volatile market conditions.",
        "Natural language processing for financial news requires sophisticated sentiment analysis and entity recognition. Watson's NLP capabilities can extract actionable insights from unstructured financial text data.",
        "Technical analysis indicators like RSI, MACD, and Bollinger Bands provide quantitative measures of market momentum and mean reversion. These indicators are particularly effective when combined with fundamental analysis.",
        "Gradient-based attribution methods provide mathematically rigorous explanations for neural network decisions. Watson recommends integrated gradients for their stability and theoretical foundations in cooperative game theory.",
        "Enterprise data integration requires robust ETL pipelines that can handle multiple data sources with different frequencies and formats. Watson's data integration capabilities ensure consistency and reliability.",
        "Temporal Graph Neural Networks excel at modeling complex interdependencies in financial systems. They can capture how correlations between assets change during different market regimes and economic cycles.",
        "Model interpretability is crucial for regulatory compliance in financial services. Watson's XAI capabilities help institutions meet MiFID II and other regulatory requirements for algorithmic trading transparency.",
        "Federal Reserve Economic Data (FRED) provides comprehensive macroeconomic context for financial models. Watson can automatically select and engineer relevant macro features based on economic theory and empirical evidence.",
        "Volatility forecasting requires sophisticated models that can capture clustering, mean reversion, and regime switching. TGNN++ architecture is particularly well-suited for modeling these complex temporal dynamics.",
        "Risk management applications benefit significantly from explainable AI techniques. Watson's risk analytics can identify potential model failures and provide early warning signals for portfolio managers.",
        "Time series forecasting in financial markets requires handling non-stationarity, structural breaks, and regime changes. Watson's adaptive learning algorithms can automatically adjust to changing market conditions.",
      ];

      function sendMessageToGemini() {
        const input = document.getElementById("gemini-input");
        const message = input.value.trim();
        if (!message) return;

        // Add user message
        addMessageToChat("gemini-chat", message, "user", "You");
        input.value = "";

        // Simulate typing delay and add random response
        setTimeout(() => {
          const response =
            geminiResponses[Math.floor(Math.random() * geminiResponses.length)];
          addMessageToChat("gemini-chat", response, "assistant", "Gemini");
        }, 1000 + Math.random() * 1000);
      }

      function sendMessageToWatson() {
        const input = document.getElementById("watson-input");
        const message = input.value.trim();
        if (!message) return;

        // Add user message
        addMessageToChat("watson-chat", message, "user", "You");
        input.value = "";

        // Simulate typing delay and add random response
        setTimeout(() => {
          const response =
            watsonResponses[Math.floor(Math.random() * watsonResponses.length)];
          addMessageToChat("watson-chat", response, "assistant", "Watson");
        }, 1200 + Math.random() * 800);
      }

      function addMessageToChat(chatId, message, type, sender) {
        const chat = document.getElementById(chatId);
        const messageDiv = document.createElement("div");
        messageDiv.className = `chat-message ${type}-message mb-3`;

        const badgeClass =
          sender === "Gemini"
            ? "bg-primary"
            : sender === "Watson"
            ? "bg-info"
            : "bg-secondary";

        messageDiv.innerHTML = `
          <div class="d-flex mb-2">
            <div class="badge ${badgeClass} me-2">${sender}</div>
            <div class="flex-grow-1">
              <div class="p-2 rounded ${
                type === "user" ? "bg-primary text-white ms-5" : "bg-light"
              }" style="box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                ${message}
              </div>
              <small class="text-muted">Just now</small>
            </div>
          </div>
        `;

        chat.appendChild(messageDiv);
        chat.scrollTop = chat.scrollHeight;
      }

      // Allow Enter key to send messages
      document.addEventListener("DOMContentLoaded", function () {
        document
          .getElementById("gemini-input")
          ?.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              sendMessageToGemini();
            }
          });

        document
          .getElementById("watson-input")
          ?.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              sendMessageToWatson();
            }
          });
      });
    </script>

    <!-- Fake Chatbot Comparison Section -->
    <div class="container-fluid mt-5">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-info text-white">
              <h4>
                <i class="fas fa-robot"></i> AI Assistant Comparison - DAVOTS
                Explanation
              </h4>
              <p class="mb-0"></p>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Gemini Chatbot -->
                <div class="col-md-6">
                  <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                      <h5>ü§ñ Google Gemini</h5>
                    </div>
                    <div class="card-body">
                      <div
                        class="chat-container"
                        id="gemini-chat"
                        style="
                          height: 400px;
                          overflow-y: auto;
                          border: 1px solid #ddd;
                          padding: 15px;
                          background-color: #f8f9fa;
                          border-radius: 8px;
                        "
                      >
                        <div class="chat-message assistant-message mb-3">
                          <div class="d-flex mb-2">
                            <div class="badge bg-primary me-2">Gemini</div>
                            <div class="flex-grow-1">
                              <div
                                class="bg-light p-2 rounded"
                                style="box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1)"
                              >
                                Hello! I'm Google Gemini. Ask me anything about
                                DAVOTS and explainable AI!
                              </div>
                              <small class="text-muted">Just now</small>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="input-group mt-3">
                        <input
                          type="text"
                          class="form-control"
                          id="gemini-input"
                          placeholder="Ask Gemini about DAVOTS..."
                        />
                        <button
                          class="btn btn-primary"
                          onclick="sendMessageToGemini()"
                        >
                          üì§ Send
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- IBM Watson Chatbot -->
                <div class="col-md-6">
                  <div class="card border-info">
                    <div class="card-header bg-info text-white">
                      <h5>üî∑ IBM Watson</h5>
                    </div>
                    <div class="card-body">
                      <div
                        class="chat-container"
                        id="watson-chat"
                        style="
                          height: 400px;
                          overflow-y: auto;
                          border: 1px solid #ddd;
                          padding: 15px;
                          background-color: #f8f9fa;
                          border-radius: 8px;
                        "
                      >
                        <div class="chat-message assistant-message mb-3">
                          <div class="d-flex mb-2">
                            <div class="badge bg-info me-2">Watson</div>
                            <div class="flex-grow-1">
                              <div
                                class="bg-light p-2 rounded"
                                style="box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1)"
                              >
                                Greetings! I'm IBM Watson. I'm ready to discuss
                                DAVOTS and enterprise AI explainability.
                              </div>
                              <small class="text-muted">Just now</small>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="input-group mt-3">
                        <input
                          type="text"
                          class="form-control"
                          id="watson-input"
                          placeholder="Ask Watson about DAVOTS..."
                        />
                        <button
                          class="btn btn-info"
                          onclick="sendMessageToWatson()"
                        >
                          üì§ Send
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <style>
      .chat-message {
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .chat-container {
        font-size: 0.9rem;
      }

      .chat-container .badge {
        font-size: 0.75rem;
        min-width: 60px;
        text-align: center;
      }

      .chat-message .bg-light,
      .chat-message .bg-primary {
        max-width: 80%;
        word-wrap: break-word;
      }

      .chat-message.user-message .bg-primary {
        margin-left: auto;
      }

      .input-group button {
        white-space: nowrap;
      }
    </style>
  </body>
</html>
