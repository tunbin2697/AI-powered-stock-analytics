<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XAI Dashboard - TGNN++ Stock Prediction</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <style>
      .dashboard-container {
        margin: 20px;
      }

      .card {
        margin-bottom: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        background-color: #007bff;
        color: white;
        font-weight: bold;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-ready {
        background-color: #28a745;
      }
      .status-training {
        background-color: #ffc107;
      }
      .status-error {
        background-color: #dc3545;
      }

      .metric-card {
        text-align: center;
        padding: 20px;
      }

      .metric-value {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
      }

      .metric-label {
        color: #6c757d;
        margin-top: 5px;
      }

      .loading {
        text-align: center;
        padding: 40px;
      }

      .error-message {
        color: #dc3545;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }

      .success-message {
        color: #155724;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      #davots-plot,
      #icfts-plot,
      #prediction-plot,
      #feature-importance-plot {
        height: 600px;
        min-height: 500px;
        width: 100%;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background-color: #fafafa;
      }

      #davots-plot {
        height: 700px; /* Extra height for DAVOTS heatmap */
      }

      .plot-container {
        position: relative;
        overflow: hidden;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 15px;
      }

      @media (max-width: 768px) {
        .summary-grid {
          grid-template-columns: 1fr;
        }

        #davots-plot,
        #icfts-plot,
        #prediction-plot,
        #feature-importance-plot {
          height: 400px;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <div class="row">
        <div class="col-12">
          <h1 class="mb-4">üß† XAI Dashboard - TGNN++ Stock Prediction</h1>
          <p class="lead">
            Explainable AI for Multi-Modal Stock Price Prediction using DAVOTS,
            ICFTS, and TGNN++
          </p>
        </div>
      </div>

      <!-- Control Panel -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">üéõÔ∏è Control Panel</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-3">
                  <label for="ticker" class="form-label">Stock Ticker</label>
                  <input
                    type="text"
                    class="form-control"
                    id="ticker"
                    value="AAPL"
                    placeholder="e.g., AAPL"
                  />
                </div>
                <div class="col-md-3">
                  <label for="start-date" class="form-label">Start Date</label>
                  <input type="date" class="form-control" id="start-date" />
                </div>
                <div class="col-md-3">
                  <label for="end-date" class="form-label">End Date</label>
                  <input type="date" class="form-control" id="end-date" />
                </div>
                <div class="col-md-3">
                  <label for="epochs" class="form-label">Training Epochs</label>
                  <input
                    type="number"
                    class="form-control"
                    id="epochs"
                    value="50"
                    min="10"
                    max="200"
                  />
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-12">
                  <button
                    class="btn btn-primary me-2"
                    onclick="integrateData()"
                  >
                    üìä Integrate Data
                  </button>
                  <button class="btn btn-success me-2" onclick="trainModel()">
                    üöÄ Train Model
                  </button>
                  <button class="btn btn-warning me-2" onclick="runDAVOTS()">
                    üîç DAVOTS Analysis
                  </button>
                  <button class="btn btn-info me-2" onclick="runICFTS()">
                    ‚ö° ICFTS Analysis
                  </button>
                  <button
                    class="btn btn-secondary me-2"
                    onclick="predictPrice()"
                  >
                    üí∞ Predict Price
                  </button>
                  <button
                    class="btn btn-outline-primary"
                    onclick="getModelStatus()"
                  >
                    üìà Model Status
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Status Panel -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">üìä System Status</h5>
            </div>
            <div class="card-body">
              <div id="status-messages"></div>
              <div class="row" id="status-indicators">
                <div class="col-md-3">
                  <div class="metric-card">
                    <div>
                      <span
                        class="status-indicator status-ready"
                        id="data-status"
                      ></span>
                      Data Integration
                    </div>
                    <div class="small text-muted" id="data-info">
                      Not started
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="metric-card">
                    <div>
                      <span
                        class="status-indicator status-ready"
                        id="model-status"
                      ></span>
                      Model Training
                    </div>
                    <div class="small text-muted" id="model-info">
                      Not started
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="metric-card">
                    <div>
                      <span
                        class="status-indicator status-ready"
                        id="xai-status"
                      ></span>
                      XAI Analysis
                    </div>
                    <div class="small text-muted" id="xai-info">
                      Not started
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="metric-card">
                    <div>
                      <span
                        class="status-indicator status-ready"
                        id="prediction-status"
                      ></span>
                      Prediction
                    </div>
                    <div class="small text-muted" id="prediction-info">
                      Not started
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- XAI Analysis Results -->
      <div class="row">
        <!-- DAVOTS Analysis (Full Width) -->
        <div class="col-12 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                üîç DAVOTS - Deep Attribution Visualization Over Time Series
              </h5>
              <small class="text-light">
                Explainable AI analysis showing feature importance across time
                steps
              </small>
            </div>
            <div class="card-body">
              <div id="davots-loading" class="loading" style="display: none">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">
                  Running DAVOTS analysis... This may take a moment.
                </p>
              </div>
              <div class="plot-container">
                <div id="davots-plot"></div>
              </div>
              <div id="davots-summary" class="mt-4"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- ICFTS Analysis -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">‚ö° ICFTS - Integrated Causal Feature</h5>
            </div>
            <div class="card-body">
              <div id="icfts-loading" class="loading" style="display: none">
                <div class="spinner-border" role="status"></div>
                <p>Running ICFTS analysis...</p>
              </div>
              <div id="icfts-plot"></div>
              <div id="icfts-summary" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Prediction Results -->
      <div class="row">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">üí∞ Price Prediction & Feature Importance</h5>
            </div>
            <div class="card-body">
              <div
                id="prediction-loading"
                class="loading"
                style="display: none"
              >
                <div class="spinner-border" role="status"></div>
                <p>Generating predictions...</p>
              </div>
              <div id="prediction-plot"></div>
              <div id="feature-importance-plot" class="mt-3"></div>
            </div>
          </div>
        </div>

        <!-- Model Metrics -->
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">üìà Model Performance</h5>
            </div>
            <div class="card-body">
              <div id="model-metrics">
                <div class="metric-card">
                  <div class="metric-value" id="mse-value">--</div>
                  <div class="metric-label">Avg Feature Importance</div>
                </div>
                <div class="metric-card">
                  <div class="metric-value" id="mae-value">--</div>
                  <div class="metric-label">Positive Features</div>
                </div>
                <div class="metric-card">
                  <div class="metric-value" id="r2-value">--</div>
                  <div class="metric-label">Negative Features</div>
                </div>
                <div class="metric-card">
                  <div class="metric-value" id="accuracy-value">--</div>
                  <div class="metric-label">Total Features</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Initialize dates
      const today = new Date();
      const thirtyDaysAgo = new Date(
        today.getTime() - 30 * 24 * 60 * 60 * 1000
      );
      document.getElementById("start-date").value = thirtyDaysAgo
        .toISOString()
        .split("T")[0];
      document.getElementById("end-date").value = today
        .toISOString()
        .split("T")[0];

      // Utility functions
      function showMessage(message, type = "info") {
        const messagesDiv = document.getElementById("status-messages");
        const alertClass =
          type === "error" ? "error-message" : "success-message";
        messagesDiv.innerHTML = `<div class="${alertClass}">${message}</div>`;
        setTimeout(() => (messagesDiv.innerHTML = ""), 5000);
      }

      function updateStatus(component, status, info) {
        const statusElement = document.getElementById(`${component}-status`);
        const infoElement = document.getElementById(`${component}-info`);

        statusElement.className = `status-indicator status-${status}`;
        if (infoElement) infoElement.textContent = info;
      }

      function showLoading(component, show = true) {
        const loadingElement = document.getElementById(`${component}-loading`);
        if (loadingElement) {
          loadingElement.style.display = show ? "block" : "none";
        }
      }

      function formatFeatureName(name) {
        // Format feature names for better display
        if (name.startsWith("macro_")) {
          return name.replace("macro_", "").replace(/_/g, " ");
        }
        if (name.startsWith("news_emb_")) {
          const embNum = name.replace("news_emb_", "");
          return `News Emb ${embNum}`;
        }
        return name.replace(/_/g, " ");
      }

      function getCategoryIcon(featureName) {
        if (featureName.startsWith("macro_")) return "üìä";
        if (featureName.startsWith("news_emb_")) return "üì∞";
        if (["Volume", "Volume_SMA", "Volume_Ratio"].includes(featureName))
          return "üìà";
        if (["SMA_20", "EMA_12", "EMA_26", "MACD"].includes(featureName))
          return "üìâ";
        if (featureName.includes("BB_")) return "üéØ";
        return "üí≤";
      }

      // API functions
      async function integrateData() {
        const ticker = document.getElementById("ticker").value;
        const startDate = document.getElementById("start-date").value;
        const endDate = document.getElementById("end-date").value;

        updateStatus("data", "training", "Integrating data...");
        showMessage("Integrating multi-modal data...", "info");

        try {
          const response = await fetch(
            `/lab2/xai/integrate_data?ticker=${ticker}&start=${startDate}&end=${endDate}`
          );
          const data = await response.json();

          if (response.ok) {
            updateStatus(
              "data",
              "ready",
              `${data.data_shape[0]} samples, ${data.data_shape[1]} features`
            );
            showMessage(
              `Data integration successful! Shape: ${data.data_shape[0]}x${data.data_shape[1]}`,
              "success"
            );

            // Store data info for other functions
            window.lastIntegratedData = {
              ticker: ticker,
              start: startDate,
              end: endDate,
              shape: data.data_shape,
              features: data.feature_summary,
            };
          } else {
            updateStatus("data", "error", "Integration failed");
            showMessage(`Data integration failed: ${data.error}`, "error");
          }
        } catch (error) {
          updateStatus("data", "error", "Network error");
          showMessage(
            `Network error during data integration: ${error.message}`,
            "error"
          );
        }
      }
      async function trainModel() {
        const ticker = document.getElementById("ticker").value;
        const startDate = document.getElementById("start-date").value;
        const endDate = document.getElementById("end-date").value;
        const epochs = parseInt(document.getElementById("epochs").value);

        updateStatus("model", "training", "Training in progress...");
        showMessage("Training TGNN++ model...", "info");

        try {
          const response = await fetch("/lab2/xai/train_model", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              ticker,
              start: startDate,
              end: endDate,
              epochs,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            updateStatus("model", "ready", `Trained for ${epochs} epochs`);
            showMessage(
              `Model training completed! Model saved to: ${data.model_path}`,
              "success"
            );

            // Store model info for other functions
            window.lastTrainedModel = {
              path: data.model_path,
              ticker: ticker,
              epochs: epochs,
              features: data.feature_names,
            };

            // Update metrics if available
            if (data.training_stats) {
              const stats = data.training_stats;
              document.getElementById("mse-value").textContent =
                stats.final_train_loss?.toFixed(4) || "--";
              document.getElementById("mae-value").textContent =
                stats.final_val_loss?.toFixed(4) || "--";
              document.getElementById("r2-value").textContent = "--"; // Not provided in training stats
              document.getElementById(
                "accuracy-value"
              ).textContent = `${stats.feature_count} features`;
            }
          } else {
            updateStatus("model", "error", "Training failed");
            showMessage(`Model training failed: ${data.error}`, "error");
          }
        } catch (error) {
          updateStatus("model", "error", "Network error");
          showMessage(
            `Network error during model training: ${error.message}`,
            "error"
          );
        }
      }
      async function runDAVOTS() {
        const ticker = document.getElementById("ticker").value;

        if (!window.lastTrainedModel) {
          showMessage(
            "Please train a model first before running DAVOTS analysis.",
            "error"
          );
          return;
        }

        updateStatus("xai", "training", "Running DAVOTS...");
        showLoading("davots", true);
        showMessage("Running DAVOTS attribution analysis...", "info");

        try {
          const modelPath = window.lastTrainedModel.path;
          const response = await fetch(
            `/lab2/xai/davots?ticker=${ticker}&model_path=${encodeURIComponent(
              modelPath
            )}`
          );

          const data = await response.json();
          showLoading("davots", false);

          if (response.ok) {
            updateStatus("xai", "ready", "DAVOTS completed");
            showMessage("DAVOTS analysis completed successfully!", "success"); // Plot DAVOTS results
            if (data.attribution_plot) {
              const plotData = JSON.parse(data.attribution_plot);

              // Configure plot for better display
              const config = {
                displayModeBar: true,
                modeBarButtonsToRemove: ["pan2d", "lasso2d", "select2d"],
                displaylogo: false,
                responsive: true,
              };

              // Update layout for better visualization
              if (plotData.layout) {
                plotData.layout.autosize = true;
                plotData.layout.height = 600;
                plotData.layout.margin = { l: 250, r: 50, t: 80, b: 100 };
                plotData.layout.font = { size: 12 };
                plotData.layout.xaxis.title = "Time Steps";
                plotData.layout.yaxis.title = "Features";
                plotData.layout.title = {
                  text: `DAVOTS - Feature Attribution Over Time (${data.ticker})`,
                  font: { size: 16 },
                  x: 0.5,
                };
              }

              Plotly.newPlot(
                "davots-plot",
                plotData.data,
                plotData.layout,
                config
              );

              // Add resize event listener
              window.addEventListener("resize", function () {
                Plotly.Plots.resize("davots-plot");
              });
            }

            // Show detailed summary
            if (data.feature_importance_summary && data.top_features) {
              const summary = data.feature_importance_summary;
              // Format top features properly
              let topFeaturesHtml = "";
              if (Array.isArray(data.top_features)) {
                topFeaturesHtml = '<div class="list-group list-group-flush">';
                data.top_features.slice(0, 5).forEach((feature, index) => {
                  if (Array.isArray(feature) && feature.length >= 2) {
                    const [name, score] = feature;
                    const formattedName = formatFeatureName(name);
                    const icon = getCategoryIcon(name);
                    const percentage = (score * 100).toFixed(4);
                    const badgeColor =
                      index === 0
                        ? "bg-primary"
                        : index === 1
                        ? "bg-success"
                        : "bg-secondary";

                    topFeaturesHtml += `
                      <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                          ${icon} <strong>${formattedName}</strong>
                          <br><small class="text-muted">${name}</small>
                        </span>
                        <span class="badge ${badgeColor} rounded-pill">${percentage}%</span>
                      </div>
                    `;
                  } else if (typeof feature === "string") {
                    const icon = getCategoryIcon(feature);
                    topFeaturesHtml += `
                      <div class="list-group-item">
                        ${icon} ${formatFeatureName(feature)}
                      </div>
                    `;
                  }
                });
                topFeaturesHtml += "</div>";
              }

              document.getElementById("davots-summary").innerHTML = `
                <div class="row">
                  <div class="col-md-6">
                    <h6>üìä Attribution Summary:</h6>
                    <ul class="list-unstyled">
                      <li><strong>üî∫ Most Influential:</strong> <code>${
                        summary.most_positive
                      }</code></li>
                      <li><strong>üîª Least Influential:</strong> <code>${
                        summary.most_negative
                      }</code></li>
                      <li><strong>üìà Average Attribution:</strong> ${(
                        summary.avg_attribution * 100
                      ).toFixed(6)}%</li>
                      <li><strong>üéØ Analysis Method:</strong> ${
                        data.method || "Integrated Gradients"
                      }</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6>üèÜ Top Contributing Features:</h6>
                    ${topFeaturesHtml}
                  </div>
                </div>
                <div class="mt-3">
                  <small class="text-muted">
                    <i>‚ÑπÔ∏è The heatmap shows feature attribution over the last 30 time steps. 
                    Darker colors indicate higher influence on the model's prediction.</i>
                  </small>
                </div>
              `;
            }
          } else {
            updateStatus("xai", "error", "DAVOTS failed");
            showMessage(`DAVOTS analysis failed: ${data.error}`, "error");
          }
        } catch (error) {
          showLoading("davots", false);
          updateStatus("xai", "error", "Network error");
          showMessage(
            `Network error during DAVOTS analysis: ${error.message}`,
            "error"
          );
        }
      }
      async function runICFTS() {
        const ticker = document.getElementById("ticker").value;

        updateStatus("xai", "training", "Running ICFTS...");
        showLoading("icfts", true);
        showMessage("Running ICFTS causal analysis...", "info");

        try {
          const response = await fetch(
            `/lab2/xai/icfts?ticker=${ticker}&sentiment_var=avg_sentiment&target_var=close_price`
          );

          const data = await response.json();
          showLoading("icfts", false);

          if (response.ok) {
            updateStatus("xai", "ready", "ICFTS completed");
            showMessage("ICFTS analysis completed successfully!", "success");

            // Plot ICFTS results
            if (data.causal_graph_plot) {
              const plotData = JSON.parse(data.causal_graph_plot);
              Plotly.newPlot("icfts-plot", plotData.data, plotData.layout);
            }

            // Show summary
            if (data.interpretation) {
              const interp = data.interpretation;
              document.getElementById("icfts-summary").innerHTML = `
                            <h6>Causal Analysis Summary:</h6>
                            <p><strong>Causal relationship:</strong> ${
                              interp.causal_relationship ? "Yes" : "No"
                            }</p>
                            <p><strong>Strength level:</strong> ${
                              interp.strength_level
                            }</p>
                            <p><strong>Causal strength:</strong> ${data.causal_strength.toFixed(
                              4
                            )}</p>
                            <p><strong>Statistical significance:</strong> ${
                              interp.statistical_significance ? "Yes" : "No"
                            } (p=${data.p_value.toFixed(4)})</p>
                        `;
            }
          } else {
            updateStatus("xai", "error", "ICFTS failed");
            showMessage(`ICFTS analysis failed: ${data.error}`, "error");
          }
        } catch (error) {
          showLoading("icfts", false);
          updateStatus("xai", "error", "Network error");
          showMessage(
            `Network error during ICFTS analysis: ${error.message}`,
            "error"
          );
        }
      }
      async function predictPrice() {
        const ticker = document.getElementById("ticker").value;
        const predictionDays = 5; // Default prediction days

        if (!window.lastTrainedModel) {
          showMessage(
            "Please train a model first before making predictions.",
            "error"
          );
          return;
        }

        updateStatus("prediction", "training", "Generating predictions...");
        showLoading("prediction", true);
        showMessage("Generating price predictions...", "info");

        try {
          const response = await fetch("/lab2/xai/predict", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              ticker: ticker,
              model_path: window.lastTrainedModel.path,
              prediction_days: predictionDays,
            }),
          });

          const data = await response.json();
          showLoading("prediction", false);

          if (response.ok) {
            updateStatus("prediction", "ready", "Predictions generated");
            showMessage("Price predictions generated successfully!", "success");

            // Plot predictions
            if (data.prediction_plot) {
              const plotData = JSON.parse(data.prediction_plot);
              Plotly.newPlot("prediction-plot", plotData.data, plotData.layout);
            }

            // Update prediction summary
            if (data.prediction_summary) {
              const summary = data.prediction_summary;
              const summaryHtml = `
                            <div class="mt-3">
                                <h6>Prediction Summary:</h6>
                                <p><strong>Current Price:</strong> $${data.current_price.toFixed(
                                  2
                                )}</p>
                                <p><strong>Average Predicted:</strong> $${summary.avg_predicted_price.toFixed(
                                  2
                                )}</p>
                                <p><strong>Price Trend:</strong> ${
                                  summary.price_trend
                                }</p>
                                <p><strong>Expected Change:</strong> ${
                                  summary.expected_change >= 0 ? "+" : ""
                                }$${summary.expected_change.toFixed(
                2
              )} (${summary.expected_change_pct.toFixed(1)}%)</p>
                                <p><strong>Prediction Dates:</strong> ${data.prediction_dates.join(
                                  ", "
                                )}</p>
                            </div>
                        `;
              document
                .getElementById("prediction-plot")
                .insertAdjacentHTML("afterend", summaryHtml);
            }

            // Get and display feature importance
            getFeatureImportance();
          } else {
            updateStatus("prediction", "error", "Prediction failed");
            showMessage(`Price prediction failed: ${data.error}`, "error");
          }
        } catch (error) {
          showLoading("prediction", false);
          updateStatus("prediction", "error", "Network error");
          showMessage(
            `Network error during prediction: ${error.message}`,
            "error"
          );
        }
      }
      async function getModelStatus() {
        showMessage("Checking model status...", "info");

        try {
          const response = await fetch("/lab2/xai/model_status");
          const data = await response.json();

          if (response.ok) {
            showMessage("Model status retrieved successfully!", "success");

            // Display available models info
            const modelInfo = `
                        <div class="mt-2">
                            <strong>Available Models:</strong> ${
                              data.model_count
                            }<br>
                            ${
                              data.latest_model
                                ? `<strong>Latest:</strong> ${data.latest_model.name} (${data.latest_model.size_mb}MB, ${data.latest_model.created_date})`
                                : "No models found"
                            }
                        </div>
                    `;
            document.getElementById("model-info").innerHTML = modelInfo;

            // Update status indicators based on available models
            if (data.model_count > 0) {
              updateStatus(
                "model",
                "ready",
                `${data.model_count} models available`
              );
              // Store latest model info if available
              if (data.latest_model && !window.lastTrainedModel) {
                window.lastTrainedModel = {
                  path: data.latest_model.path,
                  name: data.latest_model.name,
                };
              }
            } else {
              updateStatus("model", "ready", "No trained models");
            }
          } else {
            showMessage(`Failed to get model status: ${data.error}`, "error");
          }
        } catch (error) {
          showMessage(
            `Network error getting model status: ${error.message}`,
            "error"
          );
        }
      }

      // New function to get feature importance
      async function getFeatureImportance() {
        const ticker = document.getElementById("ticker").value;

        if (!window.lastTrainedModel) {
          return; // Skip if no model available
        }

        try {
          const response = await fetch(
            `/lab2/xai/feature_importance?ticker=${ticker}&model_path=${encodeURIComponent(
              window.lastTrainedModel.path
            )}`
          );
          const data = await response.json();

          if (response.ok) {
            // Plot feature importance
            if (data.feature_importance_plot) {
              const plotData = JSON.parse(data.feature_importance_plot);
              Plotly.newPlot(
                "feature-importance-plot",
                plotData.data,
                plotData.layout
              );
            }

            // Update metrics with feature importance stats
            if (data.overall_stats) {
              document.getElementById("mse-value").textContent =
                data.overall_stats.avg_importance.toFixed(4);
              document.getElementById("mae-value").textContent =
                data.overall_stats.positive_features.toString();
              document.getElementById("r2-value").textContent =
                data.overall_stats.negative_features.toString();
              document.getElementById("accuracy-value").textContent =
                data.overall_stats.total_features.toString();
            }
          } else {
            console.warn("Feature importance analysis failed:", data.error);
          }
        } catch (error) {
          console.warn(
            "Network error during feature importance analysis:",
            error.message
          );
        }
      }

      // Auto-refresh model status every 30 seconds
      setInterval(getModelStatus, 30000);

      // Initial status check
      getModelStatus();
    </script>
  </body>
</html>
